<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自动化部署 | Riku&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="知识整理">
    <meta name="keywords" content="知识整理">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.2b4a33db.css" as="style"><link rel="preload" href="/assets/js/app.8a3ae5f1.js" as="script"><link rel="preload" href="/assets/js/2.fbbb7b81.js" as="script"><link rel="preload" href="/assets/js/11.807323d2.js" as="script"><link rel="prefetch" href="/assets/js/10.865824eb.js"><link rel="prefetch" href="/assets/js/12.0479603f.js"><link rel="prefetch" href="/assets/js/13.e8f672b6.js"><link rel="prefetch" href="/assets/js/14.0718d54e.js"><link rel="prefetch" href="/assets/js/15.adb84ad6.js"><link rel="prefetch" href="/assets/js/16.7469cb02.js"><link rel="prefetch" href="/assets/js/17.51a1ee74.js"><link rel="prefetch" href="/assets/js/18.274aa6b1.js"><link rel="prefetch" href="/assets/js/19.2fd786e6.js"><link rel="prefetch" href="/assets/js/20.ea598d55.js"><link rel="prefetch" href="/assets/js/21.8ed232c6.js"><link rel="prefetch" href="/assets/js/22.10fa5a9d.js"><link rel="prefetch" href="/assets/js/23.1f843d26.js"><link rel="prefetch" href="/assets/js/24.0e18e95e.js"><link rel="prefetch" href="/assets/js/25.ca541120.js"><link rel="prefetch" href="/assets/js/26.e377677c.js"><link rel="prefetch" href="/assets/js/27.16960daa.js"><link rel="prefetch" href="/assets/js/3.9119fdf5.js"><link rel="prefetch" href="/assets/js/4.6bc50a21.js"><link rel="prefetch" href="/assets/js/5.0ff9a6d8.js"><link rel="prefetch" href="/assets/js/6.b402d03c.js"><link rel="prefetch" href="/assets/js/7.92659bbb.js"><link rel="prefetch" href="/assets/js/8.bee9f62a.js"><link rel="prefetch" href="/assets/js/9.acf4edca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2b4a33db.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://gitee.com/chobits01/image/raw/master/image/sun.png" alt="Riku's blog" class="logo"> <span class="site-name can-hide">Riku's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/archives/" class="nav-link">Timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://gitee.com/chobits01/image/raw/master/image/riku.jpg"> <div class="blogger-info"><h3>Riku</h3> <span>文学少年!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/archives/" class="nav-link">Timeline</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/friends.html" class="nav-link">friends</a></div><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><a href="/categories/?category=devops" title="分类" data-v-33863c7e>devops</a></li> <!----> <!----></ul> <div class="info" data-v-33863c7e><div title="作者" class="author iconfont icon-touxiang" data-v-33863c7e><a href="https://github.com/mowanqing" target="_blank" title="作者" class="beLink" data-v-33863c7e>Riku</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2021-03-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          自动化部署
        </h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="自动化部署"><a href="#自动化部署" class="header-anchor">#</a> 自动化部署</h1> <h2 id="持续交付"><a href="#持续交付" class="header-anchor">#</a> 持续交付</h2> <p>概念: 交付 + 版本控制+ 持续集成工具+部署工具 = 持续交付</p> <h2 id="gitlab"><a href="#gitlab" class="header-anchor">#</a> GitLab</h2> <p>Gitlab是一个开源分布式版本控制系统</p> <p>开发语言:Ruby</p> <p>功能:管理项目源代码,版本控制,代码复用与查找</p> <p>Github分布式在线代码托管仓库,个人版本暴露在公网上,不安全,企业版要收费</p> <p>Gitlab分布式在线代码仓库托管软件,社区免费版+服务器可以搭建私人代码仓库</p> <p>优势:</p> <ul><li>开源免费,时和中小型公司将代码放置在该系统中,要进行二次开发,只需升级到企业版,现行的代码仓库可以无缝衔接</li> <li>差异化的版本管理,离线同步以及强大的分支管理功能</li> <li>便捷的GUI操作界面一级强大的账户权限管理功能</li> <li>集成度很高,能够集成绝大多数的开发工具</li> <li>支持内置HA,保证在高并发下仍旧实现高可用性</li></ul> <h3 id="主要服务构成"><a href="#主要服务构成" class="header-anchor">#</a> 主要服务构成</h3> <ul><li>Nginx静态Web服务器(处理https请求)</li> <li>Gitlab-workhorse轻量级的反向代理服务器(处理一些较大的文件上传下载,以及经常使用的git push 命令行操作)</li> <li>Gitlab-shell用于处理Git命令和修改authorized keys列表</li> <li>Logrotate 日志文件管理工具(日志的切割,打包操作)</li> <li>Posstgresql 数据库(保存所有数据信息)</li> <li>Redis缓存服务器(缓存数据库信息,加快前台的访问速度,以及数据的交互读写)</li></ul> <h3 id="gitlab的工作流程"><a href="#gitlab的工作流程" class="header-anchor">#</a> Gitlab的工作流程</h3> <ul><li>创建并克隆项目</li> <li>创建项目某Feature分支</li> <li>编写代码并提交至该分支</li> <li>推送该项目分支至远程Gitlab服务器</li> <li>进行代码检查并提交Master分支合并申请</li> <li>项目领导审查代码并确认合并申请</li></ul> <h3 id="gitlab安装配置管理"><a href="#gitlab安装配置管理" class="header-anchor">#</a> Gitlab安装配置管理</h3> <ul><li><p>利用VitualBox创建测试服务器(centos7)</p></li> <li><p>安装Gitlab前系统预配置准备</p> <ol><li><p>关闭firewalled防火墙</p> <p><code># systemctl stop firewalld</code></p> <p><code># systemctl disable firewalld</code>(禁用开机启动)</p></li> <li><p>关闭SELINUX并重启系统(强制访问安全策略)</p> <p><code># vi /etc/sysconfig/selinux</code></p> <p>...</p> <p>SELINUX=disabled</p> <p>...</p> <p><code># reboot</code></p></li> <li><p>安装Omnibus Gitlab-ce package</p> <ol><li><p>安装Gitlab组件</p> <p><code>yum install curl policycoreutils openssh-server openssh-clients postfixs</code></p></li> <li><p>配置YUM仓库</p> <p><code># curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | bash</code></p></li> <li><p>启动postfix邮件服务</p> <p><code># systemctl start postfix &amp;&amp; systemctl enable postfix</code></p></li> <li><p>安装Gitlab-ce社区版本</p> <p><code># yum install -y gitlab-ce</code></p></li> <li><p>Omnibus Gitlab等相关配置初始化并完成安装</p> <ol><li><p>证书创建与配置加载</p> <ol><li><p><code># openssl genrsa -out &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot; 2048</code>(密钥)</p></li> <li><p><code># openssl req -new -key &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.example.com.csr&quot;</code>(根据密钥创建的证书)</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Country Name <span class="token punctuation">(</span><span class="token number">2</span> letter code<span class="token punctuation">)</span> <span class="token punctuation">[</span>XX<span class="token punctuation">]</span>:cn
State or Province Name <span class="token punctuation">(</span>full name<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:js
Locality Name <span class="token punctuation">(</span>eg, city<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default City<span class="token punctuation">]</span>:sz
Organization Name <span class="token punctuation">(</span>eg, company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default Company Ltd<span class="token punctuation">]</span>:
Organizational Unit Name <span class="token punctuation">(</span>eg, section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:
Common Name <span class="token punctuation">(</span>eg, your name or your server's <span class="token function">hostname</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:gitlab.example.com
Email Address <span class="token punctuation">[</span><span class="token punctuation">]</span>:riku7032@163.com

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p><code>openssl x509 -req -days 365 -in &quot;/etc/gitlab/ssl/gitlab.example.com.csr&quot; -signkey &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</code>(签署crt证书)</p></li> <li><p><code>openssl dhparam -out /etc/gitlab/ssl/dhparams.pem 2048</code>(创建pem证书)</p></li> <li><p>修改gitlab配置</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/gitlab/gitlab.rb
external_url <span class="token string">'https://gitlab.example.com'</span>
nginx<span class="token punctuation">[</span><span class="token string">'redirect_http_to_https'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment"># nginx['ssl_certificate'] = &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span>
<span class="token comment"># nginx['ssl_certificate_key'] = &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span>
<span class="token comment"># nginx['ssl_dhparam'] = /etc/gitlab/ssl/dhparams.pem # Path to dhparams.pem, eg. /etc/gitlab/ssl/dhparams.pem</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol></li> <li><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#执行gitlab-ctl reconfigure前先运行以下命令,docker需要</span>
/opt/gitlab/embedded/bin/runsvdir-start <span class="token operator">&amp;</span>
<span class="token comment">#初始化完成后</span>
<span class="token function">vim</span> /var/opt/gitlab/nginx/conf/gitlab-http.conf
rewrite ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ https://<span class="token variable">$host</span><span class="token variable">$1</span> permanent<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>Nginx SSL代理服务配置</p></li> <li><p>初始化Gitlab相关服务并完成安装</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>在宿主机更改 <span class="token function">vim</span> /etc/hosts文件
将docker容器的ip地址加入到文件中并换成gitlab.example.com
创建仓库
<span class="token function">mkdir</span> repo 
<span class="token builtin class-name">cd</span> repo 
<span class="token function">git</span> -c http.sslverify<span class="token operator">=</span>false clone https://gitlab.example.com/root/test-repo.git
<span class="token function">vim</span> test.py
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;first commit&quot;</span>
<span class="token function">git</span> -c http.sslverify<span class="token operator">=</span>false push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ol></li></ol></li></ol></li></ul> <h3 id="docker-centos容器配置"><a href="#docker-centos容器配置" class="header-anchor">#</a> docker centos容器配置</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -d -p 5022:22 --name centos --privileged=true centos:7 /usr/sbin/init
docker exec -it centos /bin/bash
yum -y install bind bind-utils net-tools
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="应用"><a href="#应用" class="header-anchor">#</a> 应用</h3> <ul><li>Gitlab后台管理</li> <li>开发是角的Gitlab</li> <li>运维视角的Gitlab(监控cpu,内存,硬盘等系统健康,保证在高并发下的高可用,权限分配问题)</li> <li>Gitlab不同角色使用实例</li></ul> <h2 id="ansible"><a href="#ansible" class="header-anchor">#</a> Ansible</h2> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p>ansible是一个开源部署工具</p> <p>开发语言为Python</p> <p>特点:SSH协议通讯,全平台,无需编译,模块化部署管理</p> <p>作用:推送Playbook进行远程节点快速部署</p> <h3 id="ansibe与chef-saltstack的不同"><a href="#ansibe与chef-saltstack的不同" class="header-anchor">#</a> Ansibe与Chef,Saltstack的不同</h3> <ul><li>Chef
<ul><li>Ruby语言编写,C/S架构,配置需要Git依赖,Recipe脚本编写规范,需要编程经验</li></ul></li> <li>Saltstack
<ul><li>Python语言编写,C/S架构,模块化配置管理,YAML脚本编写规范,适合大规模集群部署</li></ul></li> <li>Ansible
<ul><li>Python语言编写,无Client,模块化配置管理,Playbook脚本编写规范,易于上手,适合中小规模快速部署.</li></ul></li></ul> <h3 id="ansible的优势和应用场景"><a href="#ansible的优势和应用场景" class="header-anchor">#</a> Ansible的优势和应用场景</h3> <ol><li>轻量级无客户端(Agentless)(不需要Client,减轻部署成本,使用SSH作为替代)</li> <li>开源免费,学习成本低,快速上手</li> <li>使用Playbook作为核心配置架构,统一的脚本格式批量化部署</li> <li>完善的模块化扩展,支持目前主流的开发场景</li> <li>强大的稳定性和兼容性</li> <li>活跃的官方社区问题讨论,方便Trubleshooting与DEBUG问题</li></ol> <h3 id="ansible配合virtualenv安装配置"><a href="#ansible配合virtualenv安装配置" class="header-anchor">#</a> Ansible配合Virtualenv安装配置</h3> <p>使用python自带的Virtualenv去隔离python3.6和ansibe2.5,保证这个语言环境只提供给ansible</p> <ul><li><p>Ansible的两种安装模式(Centos7)</p> <ol><li><p>Yum包管理安装</p> <p><code># yum -y install ansible</code>(该ansible成为系统下全局的工具)</p></li> <li><p>Git源代码安装(推荐)</p> <p><code># git clone https://github.com/ansible/ansible.git</code></p> <p>配合virtualenv实现ansible在独立的python环境下运行</p></li></ol></li> <li><p>Ansible2.5+python3.6安装步骤(Centos7)</p> <ol><li><p>预先安装Python3.6版本</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> <span class="token function">wget</span> http://www.python.org/ftp/python/3.6.5/Python-3.6.5.tar.xz
 <span class="token function">tar</span> xf Python-3.6.5.tar.xz
 ./configure --prefix<span class="token operator">=</span>/usr/local --with-ensurepip<span class="token operator">=</span>install --enable-shared <span class="token assign-left variable">LDFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-wl,-rpath /usr/local/lib&quot;</span>
 <span class="token comment"># --prefix=/usr/local 安装在该目录下</span>
 <span class="token comment"># --with-ensurepip=install 安装包管理工具</span>
 <span class="token comment"># --enable-shared LDFLAGS=&quot;-wl,-rpath /usr/local/lib&quot; 用来匹配当前系统参数的值</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> altinstall
<span class="token function">ln</span> -s /usr/local/bin/pip3.6 /usr/local/bin/pip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>安装Virtualenv</p> <p><code># pip install virtualenv</code></p></li> <li><p>创建Ansible账户并安装python3.6版本Virtualenv实例</p> <p><code># useradd deploy &amp;&amp; su - deploy</code></p> <p><code># virtualenv -p /usr/local/bin/python3 .py3-a2.5-env</code></p></li> <li><p>Git源代码安装ansible2.5</p> <p><code>yum -y install git nss curl</code></p> <p><code># cd /home/deploy/.py3-a2.5-env</code></p> <p><code># git clone https://github.com/ansible/ansible.git</code></p> <p><code># cd ansible &amp;&amp; git checkout stable-2.5</code></p></li> <li><p>加载python3.6 virtualenv环境(每次加载时一定要做)</p> <p><code># source /home/deploy/.py3-a2.5-env/bin/activate</code></p></li> <li><p>安装ansible依赖包</p> <p><code># pip install paramiko PyYAML jinja2</code></p></li> <li><p>在python3.6虚拟环境下加载ansible2.5</p> <p><code># mv ansible/ .py3-a2.5-env/</code></p> <p><code># git checkout stable-2.5</code></p> <p><code># source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</code></p></li> <li><p>验证ansible2.5</p> <p><code># ansible --version</code></p></li></ol></li></ul> <h3 id="ansible-playbooks入门和编写规范"><a href="#ansible-playbooks入门和编写规范" class="header-anchor">#</a> Ansible playbooks入门和编写规范</h3> <p>playbooks基础的任务文件格式为YAML,playbooks像一个总的乐谱,每一个YAML文件称做为一个playbook乐章,在这个playbook下去编写一个或多个task做为这个乐章的音符,通过ansible的相关命令去play演奏这个乐谱,就可以预先将我们写好的任务,按照特定的编排,部署到远程服务器当中.</p> <h3 id="playbooks框架与格式"><a href="#playbooks框架与格式" class="header-anchor">#</a> Playbooks框架与格式</h3> <h4 id="test-playbooks"><a href="#test-playbooks" class="header-anchor">#</a> TEST Playbooks</h4> <p>文件结构:</p> <p>inventory/ (存放一个或多个Server详细清单目录,用来保存目标部署主机的相关域名或者IP地址,以及该主机的变量参数,根据dev,uat单元测试环境,production环境,用来给server清单命名,对应清单下的主机地址具体部署到哪个环境当中)</p> <p>​	testenv (具体清单与变量声明文件,将testenv下的主机地址部署到test环境当中)</p> <p>roles/ (保存详细的roles任务列表,它下面可以存放一个或多个role,通常或命名为具体的APP,或者项目名称)</p> <p>​	testbox/ (testbox详细任务,做为我们的项目名称)</p> <p>​		tasks/(用来保存我们最终的taskbox任务乐章文件)</p> <p>​			main.yml(testbox主任务文件)</p> <p>deploy.yml (Playbooks任务入口文件,它将调度我们roles下需要去部署的项目,以及该项目下的所有任务,最终将该任务部署在我们的inventory/ 下定义的目标主机中)</p> <ul><li><p>详细目录testenv</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>testservers<span class="token punctuation">]</span> <span class="token comment">#server组列表,可以保存一个或者多个目标主机的域名或者ip地址</span>
test.example.com <span class="token comment"># 目标部署服务器的主机名(域名)</span>

<span class="token punctuation">[</span>testservers<span class="token punctuation">:</span>vars<span class="token punctuation">]</span> <span class="token comment"># server组列表参数标签,用来定义该组下的远程主机用到的所有的key/value参数键值对作为我们server组的变量声明</span>
server_name=test.example.com
user=root
output=/root/test.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>主任务文件main.yml(用来保存特定role下面需要执行的具体任务乐章,这里乐章里面会保存一个或多个task作为我们的音符)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> name<span class="token punctuation">:</span>Print server name and user to remote testbox <span class="token comment"># 任务名称定义task名称</span>
  shell<span class="token punctuation">:</span><span class="token string">&quot;echo 'Currently {{user}} is logining {{server_name}}' &gt; {{output}}&quot;</span> <span class="token comment">#具体要执行的任务,通常调用ansible内建模块去编排我们的任务逻辑</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>任务入口文件deploy.yml(直接和playbook命令直接对话,它将playbooks下的所有编排内容展示给我们的ansible命令进行最终的play演奏,最后部署到对应的目标主机当中)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> hosts<span class="token punctuation">:</span><span class="token string">&quot;testservers&quot;</span> <span class="token comment"># server列表 对应server组列表参数标签,用来调用这个标签下的定义的目标主机(test.example.com),告诉playbook命令,需要部署的主机是谁</span>
  gather_facts<span class="token punctuation">:</span><span class="token boolean important">true</span> <span class="token comment"># 获取server基本信息,用来获取目标主机下的一些基本信息</span>
  remote_user<span class="token punctuation">:</span>root <span class="token comment"># 目标服务器系统用户指定 告诉playbook命令,使用目标主机下的root用户,进行所有的文件系统操作</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span> <span class="token comment"># 进入roles/testbox任务目录 告诉playbook命令,进入这个目录去执行任务</span>
  	<span class="token punctuation">-</span> testbox
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <h4 id="ssh免密码密钥认证"><a href="#ssh免密码密钥认证" class="header-anchor">#</a> SSH免密码密钥认证</h4> <ul><li><p>Ansible服务器端创建SSH本地密钥</p> <p><code># ssh-keygen -t rsa</code></p></li> <li><p>Ansible服务器端建立与目标部署机器的密钥认证</p> <p><code># ssh-copy-id -i /home/deploy/.ssh/id_rsa.pub root@test.example.com</code></p></li></ul> <h4 id="执行playbooks"><a href="#执行playbooks" class="header-anchor">#</a> 执行Playbooks</h4> <ul><li><p>部署到testenv环境</p> <p><code># ansible-playbook -i inventory/testenv ./deploy.yml</code></p></li></ul> <h4 id="实战编写playbooks"><a href="#实战编写playbooks" class="header-anchor">#</a> 实战编写playbooks</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/hosts <span class="token comment"># 将目标主机的主机名以及ip地址写入</span>

<span class="token function">mkdir</span> test_playbooks
├── deploy.yml
├── inventory
│   └── testenv
└── roles
    └── testbox
        └── tasks
            └── main.yml
<span class="token comment">#deploy.yml:</span>
- hosts: <span class="token string">&quot;testservers&quot;</span>
  gather_facts: <span class="token boolean">true</span>
  remote_user: root
  roles:
    - testbox
<span class="token comment">#testenv:</span>
<span class="token punctuation">[</span>testservers<span class="token punctuation">]</span>
test.example.com:5023

<span class="token punctuation">[</span>testservers:vars<span class="token punctuation">]</span>
<span class="token assign-left variable">server_name</span><span class="token operator">=</span>test.example.com
<span class="token assign-left variable">user</span><span class="token operator">=</span>root
<span class="token assign-left variable">output</span><span class="token operator">=</span>/root/test.txt

<span class="token comment"># main.yml:</span>
- name: Print server name and user to remote testbox
  shell: <span class="token string">&quot;echo 'Currently {{ user }} is logining {{ server_name }}' &gt; {{ output }}&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="ansible-playbooks常用模块"><a href="#ansible-playbooks常用模块" class="header-anchor">#</a> Ansible Playbooks常用模块</h3> <p>ansible的模块是由ansible对特定部署操作脚本的打包封装后的成品,我们可以利用该成品直接去编写playbooks,大大简化里对部署脚本编写的逻辑,方便后期维护管理</p> <h4 id="file模块"><a href="#file模块" class="header-anchor">#</a> file模块</h4> <ul><li>在目标主机创建文件或目录,并赋予其系统权限</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>通过file模块执行的一个task任务
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create a file
  <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token string">'path=/root/foo.txt state=touch mode=0755 owner=foo group=foo'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="copy模块"><a href="#copy模块" class="header-anchor">#</a> copy模块</h4> <ul><li>实现Ansible服务端到目标主机的文件传送</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy a file
  <span class="token key atrule">copy</span><span class="token punctuation">:</span> <span class="token string">'remote_src=no src=roles/testbox/files/foo.sh dest=/root/foo.sh mode=0644 force=yes'</span>
<span class="token comment"># remote_src=no声明我们是需要去将源ansible主机端的文件传送到我们的目标主机当中</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="stat模块"><a href="#stat模块" class="header-anchor">#</a> Stat模块</h4> <ul><li>获取远程文件状态信息(并将其信息保存在一个环境变量下供随后使用)</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> check if foo.sh exists
  <span class="token key atrule">stat</span><span class="token punctuation">:</span> <span class="token string">'path=/root/foo.sh'</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> script_stat 
 <span class="token comment"># register将stat获取到的文件信息传送给script_stat这个变量</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="debug模块"><a href="#debug模块" class="header-anchor">#</a> Debug模块</h4> <ul><li>打印语句到Ansible执行输出</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=foo.sh exists
  <span class="token key atrule">when</span><span class="token punctuation">:</span> script_stat.stat.exists
<span class="token comment"># when调用之前使用script_stat信息来进行判断</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="command-shell模块"><a href="#command-shell模块" class="header-anchor">#</a> Command/Shell模块</h4> <ul><li>用来执行Linux目标主机命令行(shell可以使用/bin/bash,所以可以使用管道符,重定向符,command不行)</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run the script
  <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'sh /root/foo.sh'</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run the script
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">&quot;echo 'test' &gt; /root/test.txt&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="template模块"><a href="#template模块" class="header-anchor">#</a> Template模块</h4> <ul><li>实现Ansible服务端到目标主机的jinja2模板传送(利用jinja的语法格式编写一个app配置文件,例如nginx配置文件,在里面添加一些变量参数,然后通过定义ansible的变量参数,将我们的模板传送到目标主机的app配置文件目录,从而实现我们对不同环境的app的配置参数管理)</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> write the nginx config file
  <span class="token key atrule">template</span><span class="token punctuation">:</span> src=roles/testbox/templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="packaging模块"><a href="#packaging模块" class="header-anchor">#</a> Packaging模块</h4> <ul><li>调用目标主机系统包管理工具(yum,apt)进行安装(是一个广义的模块集yum,apt是子模块)</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure nginx is at the latest version
  <span class="token key atrule">yum</span><span class="token punctuation">:</span> pkg=nginx state=latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure nginx is at the latest version
  <span class="token key atrule">apt</span><span class="token punctuation">:</span> pkg=nginx state=latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="service模块"><a href="#service模块" class="header-anchor">#</a> Service模块</h4> <ul><li>管理目标主机init系统服务(调用service systemctl去管理系统服务资源的启动,停止状态检查)</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start nginx service
  <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>ansible主机 root@192.168.122.128 <span class="token punctuation">-</span>p 5022
ssh root@test.example.com <span class="token punctuation">-</span>p 5023
test主机 root@192.168.122.128 <span class="token punctuation">-</span>p 5023
<span class="token comment"># 远程文件创建</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create a file
  <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token string">'path=/root/foo.txt state=touch mode=0755 owner=foo group=foo'</span>
<span class="token comment"># 本地到远程文件传送</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy a file
  <span class="token key atrule">copy</span><span class="token punctuation">:</span> <span class="token string">'remote_src=no src=roles/testbox/files/foo.sh dest=/root/foo.sh mode=0644 force=yes'</span>
<span class="token comment"># 获取文件状态</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> check if foo.sh exists
  <span class="token key atrule">stat</span><span class="token punctuation">:</span> <span class="token string">'path=/root/foo.sh'</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> script_stat 
<span class="token comment"># 查看文件是否存在</span>
<span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;foo.sh exists&quot;
  <span class="token key atrule">when</span><span class="token punctuation">:</span> script_stat.stat.exists
<span class="token comment"># 远程sh执行文件</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run the script
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">&quot;echo 'test' &gt; /root/test.txt&quot;</span>
<span class="token comment"># 本地到远程模板传送</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> write the nginx config file
  <span class="token key atrule">template</span><span class="token punctuation">:</span> src=roles/testbox/templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf
<span class="token comment"># 安装nginx</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure nginx is at the latest version
  <span class="token key atrule">yum</span><span class="token punctuation">:</span> pkg=nginx state=latest
<span class="token comment"># 启动nginx</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start nginx service
  <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>安装nginx</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">source</span> .py3-a2.5-env/bin/activate
<span class="token builtin class-name">source</span> .py3-a2.5-env/ansible/hacking/env-setup -q
ansible-playbook --version
<span class="token function">ssh</span> root@test.example.com -p <span class="token number">5023</span>
<span class="token function">useradd</span> foo
<span class="token function">useradd</span> deploy
<span class="token function">mkdir</span> /etc/nginx
<span class="token comment"># 安装一个nginx的yum源,保证我们随后可以利用相应的ansible模块在我们的目标主机上安装我们的nginx安装包</span>
<span class="token function">rpm</span> -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
<span class="token comment"># 编写主任务清单</span>
<span class="token function">vim</span> roles/testbox/tasks/main.yml
<span class="token comment"># 执行playbook</span>
ansible-playbook -i inventory/testenv ./deploy.yml
<span class="token function">ssh</span> root@test.example.com -p <span class="token number">5023</span> <span class="token function">ls</span> -l /root/foo.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="jenkins"><a href="#jenkins" class="header-anchor">#</a> JenKins</h2> <ul><li>JenKins是一个开源持续集成工具(使用java开发提供了软件开发的集成服务,支持很多主流软件的配置管理工具与其配合实现软件配置管理,持续集成功能)</li> <li>Java</li> <li>功能:提供了软件开发的持续集成服务</li> <li>特点:支持主流软件配置管理,配合实现软件配置管理,持续集成功能</li></ul> <blockquote><p>传统运维的工作像一个黑盒,每天写的脚本,执行的命令数以万计,如何去管理,如何去审计,如何在数以万计的服务器中和同事配合在一起协同完成某一项工作,则是我们需要去考虑的问题,如果仅限于command,如果遇到突发情况,将疲于奔命,虽然可以知道在哪里写的脚本有什么用,在哪里执行的命令,实现了什么功能,但没有办法有一套完整的系统去管理,和让别人去了解你日常工作的内容,对于别人来说,我的工作就是一个黑盒,jenkins彻底打开了这个黑盒,让开发人员和运维人员协同工作在一个白盒中,它在我们的运维当中,起到承上启下的作用,它的前台界面,让我们直观的收集到我们执行的脚本的相关信息,而且能作为一个pipeline,将我们的开发周期中,各个环节利用stage组合到一起,无论选择的是sona,代码质量检测工具,还是mavan或者ant,编译打包工具,还是gitlab,github,版本控制系统,ansibe,saltstack,产品部署工具,jenkins都可以将这些工具串连成一个完整的框架,最终实现一个高效的,可扩展的全自动部署流程平台</p></blockquote> <h3 id="jenkins的优势和应用场景"><a href="#jenkins的优势和应用场景" class="header-anchor">#</a> Jenkins的优势和应用场景</h3> <ol><li>主流的运维开发平台,兼容所有主流开发环境(它可以将我们平时开发,测试,部署,基础运维浓缩到我们每一个脚本,也就是任务当中,配合其强大的兼容性,匹配我们大中小的开发环境,无论使用centos,redhat,debian,ubuntu,windows,mac,docker都可以搭建jenkins平台,保证我们不同的开发环境都能在jenkins上运转)</li> <li>插件市场可与海量业内主流开发工具实现集成(方便将不同类型的数据在开发工具间调用处理,比如调用gitlab或者github的插件去与其进行git交互,实现clone,pull,push等操作,可以利用sona插件,给jenkins传入代码仓库地址,在sona系统下实现静态代码扫描,最终生成的报告可以检测出代码的语法是否不规范,是有bug,缺陷等,来提高代码质量,利用maven插件去通过传入对应的参数,对代码进行编译,测试,打包,并最终上传到我们的代码仓库)</li> <li>job为配置单位与日志管理,使运维和开发人员能协同工作(打开开发和运维之间的墙壁,所有人都可以通过对某一个job任务的操作配置,得到自己想要获取的信息,作为开发或者测试人员,可以无需关注去如何搭建这个平台,以及job部署配置如何实现,只需将项目所需的参数传给jenkins下对应你的项目的具体job,jenkins就会帮助你完成所有的部署,这样就能将开发与测试人员将更多的时间关注到项目代码的实现与项目测试当中,无需花费额外的时间到部署工作当中,做为运维人员就可以去关注具体的基础平台搭建维护工作,通过监控jenkins系统相关指标,保证jenkins在一个健康状态下运转,以及关注项目部署配置工作中出现的权限,参数配置,工具集成调用等问题,从而无需关注代码成面的问题,最终让我们各司其职,共同在这个平台下,完成我们项目开发周期的所有工作)</li> <li>权限管理划分不同job不同角色(jenkins严谨的权限管理功能充分的划分了每个人在开发周期内,对每一个job的不同角色,我们可以通过设定不同用户在登录系统后具有不同的权限,例如开发与测试人员只能右job任务,build,以及查看日志的权限,从而对代码进行日常测试部署等操作,运维人员在开发人员的基础上,具有对job任务的写入权限,从而进行日常的任务编写,从而保证大家不会越权去操作别人的任务,提高项目的安全性)</li> <li>jenkins强大的负载均衡功能,保证我们项目的可靠性(可以让job游走在我们的jenkins集群当中,保证具体我们开发过程中的可靠性,jenkins不仅仅是一个独立的系统,它可以在自己创建后作为一个master节点,然后衍生出若干个<em>slave</em>结点,从而组合在一起成为一个jenkins集群,这个集群的优势就在于我们可以将我们的job任务随机或者手动指定到任意master或者slave节点上去执行,最终实现我们强大的负载均衡功能,保证我们项目的可靠性,jenkins的多语言兼容性和强大的插件安装平台,保证它几乎可以适合我们所有的主流软件测试环境与生产环境,无论作为一个开发人员想部署一个java,python,php,ruby等环境,还是作为一个测试人员去集成sonar,caslink,去测试代码或者生成测试报表,jenkins都会给我们不同相关开发人员或者测试人员提供一个较为开放的平台去完成我们的工作,不需要我们在像以前传统通过command line命令行去跑我们的程序,我们可以直接在jenkins上完成所有集成部署工作,实现全平台,全语言,全环境,无缝连接的应用场景)</li></ol> <h3 id="jenkins安装配置管理"><a href="#jenkins安装配置管理" class="header-anchor">#</a> JenKins安装配置管理</h3> <ul><li><p>安装Jenkins前的环境准备(Centos7)</p> <ol><li><p>添加yum仓库源</p> <p><code># wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins.io/redhat-stable/jenkins.repo</code></p> <p><code># rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</code></p></li> <li><p>保证系统JAVA版本为8.0或8.0以上</p> <p><code># yum -y install java</code></p> <p><code># java -version</code></p></li> <li><p>关闭系统防火墙</p> <p><code># systemctl stop firewalld</code></p> <p><code># systemctl disable firewalld</code></p></li> <li><p>关闭SELINUX并重启系统</p> <p><code># vi /etc/sysconfig/selinux</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>----
<span class="token assign-left variable">SELINUX</span><span class="token operator">=</span>disabled
----
<span class="token function">reboot</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol></li> <li><p>JenKIns安装与初始化配置</p> <ol><li><p>Yum源安装Jenkins最新版本</p> <p><code># yum install jenkins</code></p></li> <li><p>创建Jenkins系统用户</p> <p><code># useradd deploy</code></p></li> <li><p>更改Jenkins启动用户与端口</p> <p><code># vi /etc/sysconfig/jenkins</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>----
<span class="token assign-left variable">JENKINS_USER</span><span class="token operator">=</span>deploy
<span class="token assign-left variable">JENKINS_PORT</span><span class="token operator">=</span><span class="token number">8080</span>
----
<span class="token function">chown</span> -R deploy:deploy /var/lib/jenkins <span class="token punctuation">(</span>家目录<span class="token punctuation">)</span>
<span class="token function">chown</span> -R deploy:deploy /var/log/jenkins
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>启动JenKins</p> <p><code># systemctl start jenkins</code></p></li></ol></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>docker run -u root --rm  -d -p <span class="token number">8080</span>:8080 -p <span class="token number">50000</span>:50000 -v jenkins-data:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock  jenkinsci/blueocean 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="jenkins-job介绍"><a href="#jenkins-job介绍" class="header-anchor">#</a> jenkins job介绍</h3> <ul><li>代表一个任务或者项目(jenkins作为一个持续集成工具,实际是由若干个job任务或者project项目构成了一个庞大的运维开发平台系统)</li> <li>可配置与可执行(利用其内建模块或者脚本语法将我们的工作内容抽象成jenkins job(任务),在该任务中,通过配置相关的参数以及工具模块,从而作为一个可执行的任务,最终共享保存到我们的jenkins平台下,供我们日常工作当中,由不同权限的工作人员重复bulid构建执行,这样通过将传统的单机图形界面或者命令行脚本去配置执行我们的日常任务迁移到jenkins这个共享平台下,去进行统一化的任务配置执行,这样就大大简化了,我们的工作流程,方便我们进行统一的任务管理工作)</li> <li>执行后的记录称之为build构建(可以通过查看这个build构建去获取到我们所需要的结果信息,最中job任务执行完成后的build构建信息会保存在我们的jenkins上,作为我们的build log日志,可以通过查看不同时间点的log信息,从而去debug去追踪我们任务执行过程中出现的各种问题,jenkins后台也会通过我们build日志数量以及大小,从而监控我们当前的jenkins健康状况)</li> <li>所有文件集中保存(clone的仓库代码,maven打包生成的编译包,我们配置的参数文件,这些都会保存在我们的jenkins主目录,然后workspace下以我们当前任务名称命名的一个目录,作为我们这个job的workspace,也就是工作区域进行保存,可以通过查看这个工作区域下的相关文件,去获取一些在我们日志文件中无法定位的问题细节,从而进行深度的问题查找,解决相对困难的问题)</li></ul> <h3 id="jenkins-freestyle-与-pipeline-job区别"><a href="#jenkins-freestyle-与-pipeline-job区别" class="header-anchor">#</a> jenkins Freestyle 与 Pipeline job区别</h3> <ul><li>Freestyle job:
<ol><li>需在页面添加模块配置项与参数完成配置</li> <li>每个job仅能实现一个开发功能</li> <li>无法将配置代码化,不利于job配置迁移与版本控制(没有审计和版本控制,谁修改配置选项不清楚)</li> <li>逻辑相对简单,无需额外学习成本</li></ol></li> <li>Pipeline job:(匹配持续集成与持续交付的概念)
<ol><li>持续集成CI:
<ul><li>是一种软件开发周期过程中的一种实践,通过将我们的代码仓库与jenkins集成,使我们开发人员的每一次代码提交都能自动在我们的jenkins自动进行任务的build构建,这样就能够帮助我们开发团队第一时间发现问题与解决问题</li></ul></li> <li>持续交付CD:
<ul><li>在持续集成的基础上,我们可以将我们构建好的软件版本,通过jenkins的自动化测试部署等多个程序,持续,安全,快速的交付到我们的用户手中</li></ul></li> <li>所有模块,参数配置都可以体现为一个pipeline脚本</li> <li>可以定义多个stage构建一个管道工作集(stage构成每一个阶段,串连我们的所有工作)</li> <li>所有配置代码化,方便job配置迁移与版本控制</li> <li>需要pipeline脚本语法基础</li></ol></li></ul> <h3 id="jenkins-job构建配置"><a href="#jenkins-job构建配置" class="header-anchor">#</a> jenkins job构建配置</h3> <ul><li>环境准备
<ol><li>配置jenkins server本地gitlab DNS</li> <li>安装git client,curl工具依赖</li> <li>关闭系统git http.sslVerify安全认证</li> <li>添加Jenkins后台Git client user与email</li></ol></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在系统配置中,将git plugin的git user和email进行填写</span>
<span class="token comment">#在凭据中的jenkins的全局凭据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="jenkins-freestyle-job-构建配置"><a href="#jenkins-freestyle-job-构建配置" class="header-anchor">#</a> jenkins freestyle job 构建配置</h3> <ol><li>创建一个Freestyle project</li> <li>编辑描述信息</li> <li>参数配置</li> <li>源代码管理</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin&quot;</span>

<span class="token comment"># Print env variable</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[INFO] Print env variable&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Current deployment envrionment is <span class="token variable">$deploy_env</span>&quot;</span> <span class="token operator">&gt;&gt;</span> test.properties
<span class="token builtin class-name">echo</span> <span class="token string">&quot;The build is <span class="token variable">$version</span>&quot;</span> <span class="token operator">&gt;&gt;</span> test.properties
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[INFO] Done...&quot;</span>

<span class="token comment"># Check test properties</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[INFO] Check test properties&quot;</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -s test.properties <span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token function">cat</span> test.properties
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;[INFO] Done...&quot;</span>
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;test.properties is empty&quot;</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;[INFO] Build finished...&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="jenkins-pipeline-job编写规范"><a href="#jenkins-pipeline-job编写规范" class="header-anchor">#</a> Jenkins Pipeline job编写规范</h3> <ul><li>pipeline基础架构
<ul><li>所有代码包裹在pipeline{}层内(声明当前代码为pipeline语法格式)</li> <li>stages{}层用来包含该pipeline所有stage子层(将pipeline管道分为若干个管道块,每个管道块都可以去干一件事情,而且彼此不受影响)</li> <li>Stage{}层用来包含具体我们需要编写任务的steps{}子层(stage后面根管道名,相当于每一个管道块,在其下定义一个steps子层,用来添加pipeline语法模块,利用模块进行业务逻辑的相关编写操作)</li> <li>steps{}层用来添加我们具体需要调用的模块语句(例如sh,echo语句)</li></ul></li> <li>特殊语法
<ul><li>agent区域
<ul><li>agent定义pipeline在那里运行(可以使用any,none或具体的jenkins node主机名等,例如,我们要特指在node1上执行,可以写成: agent {node {label 'node1'}})</li></ul></li> <li>environment区域
<ul><li>&quot;变量名称=变量值&quot;定义我们的环境变量(用来定义当前pipeline任务的系统环境变量的配置,通常与stages平级)</li> <li>可以定义全局环境变量,应用所有stages任务</li> <li>可以定义stage环境变量,应用单独的stage任务</li></ul></li> <li>script区域(可选)
<ul><li>在steps内定义script{}</li> <li>groovy脚本语言</li> <li>用来进行脚本逻辑运算</li></ul></li> <li>常用steps区域
<ul><li>echo:打印输出</li> <li>sh:调用Linux系统shell命令</li> <li>git url:调用git模块进行git相关操作</li></ul></li></ul></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>pipeline<span class="token punctuation">{</span>
  agent any
  environment<span class="token punctuation">{</span>
    <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token string">'deploy'</span>
<span class="token punctuation">}</span>
stages<span class="token punctuation">{</span>
	stage<span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
			<span class="token builtin class-name">echo</span> <span class="token variable">$deploy</span>
			<span class="token function">sh</span> <span class="token string">&quot;cat 'hello world'&quot;</span>
			<span class="token function">git</span> url:<span class="token string">&quot;https://gitlab.example.com/root/test-repo.git&quot;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>pipeline<span class="token punctuation">{</span>
agent any
stages<span class="token punctuation">{</span>
	stage<span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
			<span class="token builtin class-name">echo</span> <span class="token string">&quot;Hello World&quot;</span>
			script<span class="token punctuation">{</span>
				def servers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'node1'</span>,<span class="token string">'node2'</span><span class="token punctuation">]</span>
				For<span class="token punctuation">(</span>int <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>I<span class="token operator">&lt;</span>server.size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>++i<span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token builtin class-name">echo</span> <span class="token string">&quot;testing <span class="token variable">${servers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> server}</span>&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>pipeline<span class="token punctuation">{</span>
  agent any
environment<span class="token punctuation">{</span>
  <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">&quot;/bin:/sbin:/usr/bin&quot;</span>
  <span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token string">'test.example.com'</span>
  <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token string">'deploy'</span>
<span class="token punctuation">}</span>
stages<span class="token punctuation">{</span>
	stage<span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		environment<span class="token punctuation">{</span>
			<span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span><span class="token string">&quot;/usr/lib/jre&quot;</span>
		<span class="token punctuation">}</span>
		steps<span class="token punctuation">{</span>
			<span class="token function">sh</span> <span class="token string">&quot;cat <span class="token variable">$host</span>&quot;</span>
			<span class="token builtin class-name">echo</span> <span class="token variable">$deploy</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="jenkins-pipeline-job构建配置"><a href="#jenkins-pipeline-job构建配置" class="header-anchor">#</a> Jenkins pipeline job构建配置</h3> <ol><li>创建一个pipeline project</li> <li>ansible</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">set</span> +x
<span class="token builtin class-name">source</span> /home/deploy/.py3-a2.5-env/bin/activate
<span class="token builtin class-name">source</span> /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q

<span class="token builtin class-name">cd</span> /home/deploy
ansible --version
ansible-playbook --version

<span class="token function">cat</span> testservers

ansible -i testservers testserver -m <span class="token builtin class-name">command</span> -a <span class="token string">&quot;ip addr&quot;</span>
<span class="token builtin class-name">set</span> -x
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="实战-2"><a href="#实战-2" class="header-anchor">#</a> 实战</h2> <ul><li>三剑客平台初始环境构建</li> <li>编写ansible playbook脚本实现静态网页远程部署</li> <li>将playbook部署脚本提交到gitlab仓库</li> <li>构建freestyle job任务框架</li> <li>jenkins集成ansible与gitlab实现静态网页的自动化部署</li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3/29/2021, 4:48:26 PM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:riku7032@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/mowanqing" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.zhihu.com/people/lu-xiao-you-44-77" title="zhihu" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Powered by 
  <a href="https://vuepress.vuejs.org/zh/" target="_blank" title="Vuepress">Vuepress</a> 
    | Copyright © 2020-2021
    <span>Riku | <a href="https://github.com/vuejs/vuepress/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8a3ae5f1.js" defer></script><script src="/assets/js/2.fbbb7b81.js" defer></script><script src="/assets/js/11.807323d2.js" defer></script>
  </body>
</html>